<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaxP5Pedal | Max for Live Device</title>
    <style type="text/css">
        canvas {
            background-color: wheat
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <canvas></canvas>
    <script>
        // Canvas setup (inspired by cool_pointer.html)
        const canvas = document.querySelector('canvas');
        const ctx = canvas.getContext('2d');

        // Grid configuration
        let nb = 10;           // cells per axis
        let margin = 0;        // outer margin in px
        let cellSize = 0;      // computed from canvas size
        let pattern = [];      // fixed random directions per cell

        // Audio reactivity
        let audioLevel = 0;        // smoothed 0..1
        let audioLevelTarget = 0;  // incoming 0..1
        const smoothing = 0.15;

        function resize() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = Math.floor(window.innerWidth * dpr);
            canvas.height = Math.floor(window.innerHeight * dpr);
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            cellSize = (window.innerWidth - 2 * margin) / nb;
        }

        function generatePattern() {
            pattern = Array.from({ length: nb }, () =>
                Array.from({ length: nb }, () => Math.floor(Math.random() * 4))
            );
        }

        function drawFrame() {
            // Smooth audio
            audioLevel += (audioLevelTarget - audioLevel) * smoothing;

            // Clear and draw
            ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1 + audioLevel * 8; // map 0..1 to 1..9 px

            for (let j = 0; j < nb; j++) {
                for (let i = 0; i < nb; i++) {
                    const x = margin + i * cellSize;
                    const y = margin + j * cellSize;
                    const rnd = pattern[j][i];

                    ctx.beginPath();
                    if (rnd === 0) {
                        ctx.moveTo(x, y);
                        ctx.lineTo(x + cellSize, y + cellSize);
                    } else if (rnd === 1) {
                        ctx.moveTo(x, y + cellSize);
                        ctx.lineTo(x + cellSize, y);
                    } else if (rnd === 2) {
                        ctx.moveTo(x + cellSize / 2, y);
                        ctx.lineTo(x + cellSize / 2, y + cellSize);
                    } else {
                        ctx.moveTo(x, y + cellSize / 2);
                        ctx.lineTo(x + cellSize, y + cellSize / 2);
                    }
                    ctx.stroke();
                }
            }

            // Optional heartbeat to Max if desired
            if (window.max && typeof window.max.outlet === 'function') {
                // window.max.outlet('bang');
            }

            requestAnimationFrame(drawFrame);
        }

        // Max bridge: call from Max (jweb evaljs) to set audio [0..1]
        function receiveAudioLevel(value) {
            const v = Number(value);
            if (!Number.isNaN(v)) {
                audioLevelTarget = Math.max(0, Math.min(1, v));
            }
        }
        window.receiveAudioLevel = receiveAudioLevel; // e.g. evaljs("receiveAudioLevel(0.35)")

        // Interactions
        window.addEventListener('resize', () => {
            resize();
        });
        window.addEventListener('click', () => {
            generatePattern();
        });

        // Init
        resize();
        generatePattern();
        drawFrame();
    </script>
</body>
</html>